<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        购物车
    </title>
    <style>
        fieldset{
            width: 800px;
            margin: 20px auto;
        }
        form{
            text-align: center;
        }
        table,th,td{
            border: 1px solid black;
            border-collapse: collapse;
            width: 750px;
            margin:20px auto;
            text-align: center;
        }
        input{
            text-align: center;
        }   
    </style>
</head>
<body>
    <fieldset>
        <legend>商品信息</legend>
        <form action="">
            品名：
            <input type="text" id="goodsName"/>
            单价：
            <input type="text" id="goodsPrice"/>
            数量：
            <input type="text" id="goodsQuantity"/>
            <input type="button" id="btnAdd" value="添加"/>
        </form>
    </fieldset>
    <fieldset>
        <legend>购物车</legend>
        <table>
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="all" onclick="allCheck(this)"/>全选
                    </th>
                    <th>品名</th>
                    <th>单价</th>
                    <th>数量</th>
                    <th>小计</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="tbody">

            </tbody>
            <tfoot>
                <tr>
                    <td>总价</td>
                    <td id="total" colspan="5"></td>
                </tr>
            </tfoot>
        </table>
    </fieldset>

    <script>
        //添加按钮的触发事件
        btnAdd.onclick=function addGoods(){
            goodsRepeat();
            
        }
        //删除按钮的触发事件
        function goodsDelete(thisinput){
            //alert(thisinput.value);
            thisinput.parentElement.parentElement.remove();
            
            goodschecked();

        }
        //增加或减少 商品数量
        function changeQty(change){
            var quantity = Number(change.parentElement.children[1].value);
            if(change.value=="-"&&quantity>0){
                change.previousElementSibling.value=quantity-1;
            }else if(change.value=="+"){
                change.nextElementSibling.value=quantity+1;
            }
            subTotal(change);
            goodschecked();
        }
        //小计 site:数量框
        function subTotal(site){
            var goodsPrice = Number(site.parentElement.previousElementSibling.innerText);
            var goodsQuantity = Number(site.parentElement.children[1].value);
            site.parentElement.nextElementSibling.innerText=goodsPrice*goodsQuantity;
        }
        //计算总价+单选框触发事件
        function goodschecked(){
            var goodscheck = document.querySelectorAll(".ckgoods");
            var subtot = document.querySelectorAll(".subtot");
            var tot = 0;
            var n=0;
            for(var i = 0;i<goodscheck.length;i++){
                if(goodscheck[i].checked==true){
                    tot +=Number(subtot[i].innerText);
                    n++;
                }
            }
            if(n==goodscheck.length){
                all.checked=true;
            }else{
                all.checked=false;
            }
            //alert(tot);
            total.innerText=tot+"元";
        }
        //判断有没有已经加入购物车的物品
        function goodsRepeat(){
            var goodsname = document.querySelectorAll(".goodsname");
            //alert(goodsname[0]);
            var flag = false;
            for(var i=0;i<goodsname.length;i++){
                if(goodsname[i].innerText==goodsName.value){

                    flag = true;
                    break;
                }
            }
            //alert(flag); 
            if(flag){
                //alert(goodsname[i].parentElement.children[3]);
                var goodsquantity=goodsname[i].parentElement.children[3].children[1];
                //alert(goodsquantity.value);
                goodsquantity.value=Number(goodsquantity.value)+Number(goodsQuantity.value);
                subTotal(goodsquantity);
                goodschecked();
            }else{
                var trobj = document.createElement("tr");
                var tds ="";
                tds +="<td><input type='checkbox' class='ckgoods' onclick='goodschecked(this)'/></td>";
                tds +="<td class='goodsname'>"+goodsName.value+"</td>";
                tds +="<td>"+goodsPrice.value+"</td>";
                tds +="<td>"+
                        "<input type='button' value='+' onclick='changeQty(this)'/>"+
                        "<input type='text' value='" +goodsQuantity.value+ "' onblur='changeQty(this)'/>"+
                        "<input type='button' value='-' onclick='changeQty(this)'/>"+
                    "</td>";
                tds +="<td class='subtot'>"+(Number(goodsPrice.value)*Number(goodsQuantity.value))+"</td>";
                tds+="<td><input type='button' value='删除' onclick='goodsDelete(this)'/></td>";

                trobj.innerHTML=tds;
                tbody.appendChild(trobj);
                allCheck(all);
            } 
        }
        //全选框
        function allCheck(allCheck){
            var ckgoods = document.querySelectorAll(".ckgoods");
            //alert(allCheck.checked);
            if(allCheck.checked==true){
                //allCheck.checked=true;
                for(var i=0;i<ckgoods.length;i++){
                    ckgoods[i].checked=true;
                    goodschecked();
                }
            }else{
                for(var i=0;i<ckgoods.length;i++){
                    ckgoods[i].checked=false;
                    goodschecked();
            }
        }
    }
    </script>
</body>
</html>